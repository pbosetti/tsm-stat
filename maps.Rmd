---
title: |
  ![](logo.png){height=0.5in} ![](logo-TSM.png){height=0.4in}
  
  Mappe e GIS
author: "Paolo Bosetti (`paolo.bosetti@unitn.it`)"
output: 
  pdf_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
    toc_depth: 4
    extra_dependencies:
      babel: ["italian"]
  documentclass: article
  classoption: a4paper
---

## GGPlot
```{r show=FALSE}
knitr::opts_chunk$set(fig.align="center", fig.dim=c(6, 4), out.width="4in")
library(ggplot2)
library(lubridate)
library(xts)
theme_set(theme_bw())
```

## Standard

```{r}
a <- ggplot(mpg, aes(cty, hwy))
a + geom_smooth(formula = y~x) +
  geom_point()
```



## Serie temporali


```{r}
datafile <- "temperature-anomaly.csv"
data <- read.csv(datafile)
data <- data[data$Entity=="Global",]
t.global <- xts(data$Median.temp, 
                order.by=as.Date(as.character(data$Year), format="%Y"),
                frequency = 1)
```

```{r}
x1 <- t.global["/1999-12-31"]
p1 <- autoplot(x1) + 
  geom_hline(yintercept = 0) +
  geom_area(aes(x=index(x1), y=ifelse(x1<0, x1, 0)), fill="blue") +
  geom_area(aes(x=index(x1), y=ifelse(x1>0, x1, 0)), fill="orange") +
  labs(title="Anomalia termica", subtitle = "Terra/mare, globale") + 
  xlab("Anno") +
  ylab("Anomalia (°C)")

x2 <- t.global["2000-1-1/"]
p1 + geom_line(data=x2, aes(Index, x2), color="red") +
  #scale_x_continuous(breaks=seq(start(x1), end(x2), by="20 years")) +
  scale_x_date(breaks="10 years", date_labels="%Y") +
  scale_y_continuous(breaks=seq(round(min(t.global), 0.1), round(max(t.global), 0.1), by=0.1))
```



# Mapping

```{r}
library(tmap)
library(sf)
library(spData)
library(spDataLarge)
library(dplyr)
library(purrr)
library(stringr)
```


```{r}
tm_shape(nz) + tm_fill()
tm_shape(nz) + tm_borders()
qtm(nz) + qtm(nz_elev) + qtm(nz_height)
```

```{r}
map_nz = tm_shape(nz) + tm_polygons()
class(map_nz)
map_nz1 = map_nz +
  tm_shape(nz_elev) + tm_raster(alpha = 0.7)
print(map_nz1)
```

```{r}
nz_water = st_union(nz) %>% st_buffer(22200) %>% 
  st_cast(to = "LINESTRING")
map_nz2 = map_nz1 +
  tm_shape(nz_water) + tm_lines()

map_nz3 = map_nz2 +
  tm_shape(nz_height) + tm_dots(shape = 3)

tmap_arrange(map_nz1, map_nz2, map_nz3)
```

```{r}
#leaflet() %>% addTiles()
```


# Trentino

* Limiti amministrativi scaricati da (WebGIS)[https://webgis.provincia.tn.it/wgt/], in formato ESRI (.shp)
* Dati COVID-19 scaricati da (FBK)[https://covid19trentino.fbk.eu/data/stato_comuni_td.csv]

```{r warning=FALSE}
amm <- read_sf(dsn="ammcom/ammcom.shp")
cva <- read_sf(dsn="ammcva/ammcva.shp")
cva$nome <- cva$nome %>% str_to_title()
covid <- read.csv("https://covid19trentino.fbk.eu/data/stato_comuni_td.csv")
```

Ispezioniamo i due oggetti con `str()`:

```{r}
str(amm)
str(covid)
```

Dunque `amm` è un oggetto `sf`, la cui classe è ``r class(amm)``, mentre `covid` è ovviamente un `data.frame`. Siccome `amm` eredita da `data.frame`, possiamo aggiungere e modificare le sue colonne mediante l'operatore `$`, oppure possiamo usare la più avanzata libreria `dyplr` per unire le due tabelle condividendo le stesse colonne `nome` e `codice`:

```{r}
comuni <- amm %>% full_join(covid, by=c("codice", "nome"))
str(comuni)
```

Come si vede, ora `comuni` contiene anche i dati COVID-19.

Possiamo creare mappe attribuite mediante la libreria `tmap`, che ha una sintassi analoga a `ggplot2`: si crea una mappa con `tm_shape()` a cui si commano poi altri layer `tm_*()`:

```{r}
tm_shape(amm) + 
  tm_borders() + 
  tm_fill(col="supcom", title="Altezza") + 
  tm_bubbles(size="altcom", title.size="Quota s.l.m.", alpha=1/3) +
  #tm_text(text="nome", size="supcom") +
  tm_compass(type = "arrow", position = c("left", "top")) +
  tm_scale_bar(position=c("left", "bottom"), bg.alpha=0.5)
```

```{r}
tmap_mode("view") # Per usare tm_basemap
tmap_mode("plot")

tnplus <- st_union(comuni) %>% st_buffer(dist=2000) %>% st_cast(to="POLYGON")
tn <- tm_shape(comuni) +
  tm_borders(col="gray") + 
  tm_fill(col="contagi", title="Contagi COVID-19") +
  tm_layout(legend.outside = TRUE, legend.outside.position = "right")
tm_shape(tnplus) + tm_polygons(col="gray") + 
  tn +
  tm_shape(cva) +
  tm_borders(col="black") +
  tm_text("nome", size=2/3) +
  tm_basemap(server="OpenStreetMap")
```



